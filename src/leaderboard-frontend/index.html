<!doctype html>
<html lang="en">

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css"
    integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous">
  <title>Gamify AWS and HCP Leaderboard</title>
</head>

<body>

  <div class="container-fluid">
    <h1>Gamify AWS and HCP Leaderboard</h1>
    <div class="form-group">
      <input type="text" class="form-control" id="inputLeaderboard" placeholder="Enter function URL">
    </div>
    <div>
        <canvas id="myChart"></canvas>
    </div>
      
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>

      // Example map new team label to account id
      // TODO: Create UI elements to populate this map
      const teamMap = {
        '125900228299': 'Bit Lords',
        '417385266434': 'Byte Dogs',
        '470059844023': 'Hugs for Bugs',
        '818834411792': 'Bootstrap Trojans',
        '0': 'Reboot Rebels',
        '1': 'Debug Thugs',
      };

      // Load the chart from the function URL
      window.addEventListener('load', function() {
        leaderboardUrl = localStorage.getItem('leaderboardUrl');
        document.getElementById('inputLeaderboard').value = leaderboardUrl;

        fetch(leaderboardUrl)
          .then(response => response.json())
          .then(response => {
            newData = replaceKeys(response, teamMap)
            chart.data.datasets[0].data = newData;
            chart.update();
          })
          .catch(err => {
            console.log(err.message || err);
          })
      });

      const ctx = document.getElementById('myChart');
    
      chart = new Chart(ctx, {
        type: 'bar',
        data: {
          datasets: [{
            label: '# of points',
            data: [],
            borderWidth: 1
          }]
        },
        options: {
          layout: {
            padding: 20
          },
          responsive: true,
          plugins: {
            colors: {
              enabled: true
            }
          },
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });

      // Update the chart every 10 seconds
      setInterval(function() {
        leaderboardUrl = document.getElementById('inputLeaderboard').value;

        localStorage.setItem('leaderboardUrl', leaderboardUrl);

        fetch(leaderboardUrl)
          .then(response => response.json())
          .then(response => {
            newData = replaceKeys(response, teamMap)
            chart.data.datasets[0].data = newData;
            chart.update();
          })
          .catch(err => {
            console.log(err.message || err);
          })
      }, 10000);

      // Function to replace keys with matching teamMap values
      function replaceKeys(obj, map) {
        Object.keys(obj).forEach(function(key) {
          if (key in map) {
            obj[map[key]] = obj[key];
            delete obj[key];
          }
        });
        return obj;
      }
    </script>
</body>

</html>